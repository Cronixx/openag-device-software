{% extends 'base.html' %}

{% block javascript %}
<script>
  
  window.onload = function() {
    // document.getElementById("status").innerHTML = "Initializing"
    getInfoAndUpdateView()
  }

  function getInfoAndUpdateView() {
    console.log("Getting info and updating view")

    // Initialize system and network info
    var systemInfo = {};
    var networkInfo = {};

    // Get system info
    getSystemInfo()
      .then(function(systemInfo) {
        var systemInfo = systemInfo;
        
        // Get network info
        getNetworkInfo()
          .then(function(networkInfo) {
            var networkInfo = networkInfo;

            // Update view
            iotInfo = {"isRegistered": false, "verificationCode": "FAKECODE"}
            updateView(systemInfo, networkInfo, iotInfo)
          })
      })
      .catch(function(error) {
        console.log("Error: " + error);
      })
  }

  function updateView(systemInfo, networkInfo, iotInfo) {
    console.log("Updating view");
    console.log(systemInfo)
    console.log(networkInfo)
    console.log(iotInfo)

    // Update view for connected network and registered iot
    if (networkInfo["isConnected"] && iotInfo["isRegistered"]) {
      document.getElementById("status").innerHTML = "Successfully connected!"
      document.getElementById("ip-address").innerHTML = networkInfo["ipAddress"];
      document.getElementById("remote-device-ui-url").innerHTML = systemInfo["remoteDeviceUiUrl"];
      document.getElementById("remote-device-ui-url").href = systemInfo["remoteDeviceUiUrl"];
      document.getElementById("cloud-ui-url").innerHTML = "https://openag-v1.appspot.com/login/";
      document.getElementById("cloud-ui-url").href = "https://openag-v1.appspot.com/login/";
      $('#connection-info-collapse').collapse("show");
      $('#configure-wifi-collapse').collapse("hide");
    }

    // Update view for connected network and unregistered iot
    else if (networkInfo["isConnected"] && !iotInfo["isRegistered"]) {
      document.getElementById("status").innerHTML = "Connected to network, iot registration required"
      document.getElementById("ip-address").innerHTML = networkInfo["ipAddress"];
      document.getElementById("remote-device-ui-url").innerHTML = systemInfo["remoteDeviceUiUrl"];
      document.getElementById("remote-device-ui-url").href = systemInfo["remoteDeviceUiUrl"];
      document.getElementById("cloud-ui-url").innerHTML = "Please click here to create your user account, and connect your PFC to the OpenAg Cloud";
      document.getElementById("cloud-ui-url").href = "https://openag-v1.appspot.com/login?vcode=" + iotInfo["verificationCode"];
      $('#connection-info-collapse').collapse("show");
      $('#configure-wifi-collapse').collapse("hide");
    }

    // Update view for disconnected network and non-wifi-beaglebone system
    else if (!networkInfo["isConnected"] && !systemInfo["isWifiBeaglebone"]) {
        document.getElementById("status").innerHTML = "Unable to connect, not a wifi beaglebone"
        $("#configure-wifi-collapse").collapse("hide");
        $("#connection-info-collapse").collapse("hide");
    }

    // Update view for disconnected network and wifi-beaglebone system
    else if (!networkInfo["isConnected"] && systemInfo["isWifiBeaglebone"]) {
      document.getElementById("status").innerHTML = "Please configure your wifi network"
      updateWifiAccessPoints(networkInfo["wifiAccessPoints"])
      $("#configure-wifi-collapse").collapse("show");
      $("#network-info-collapse").collapse("hide");
    }

  }

  function updateWifiAccessPoints(wifiAccessPoints) {
    console.log("Updating wifi access points")

    // Remove stale wifi access point selections
    var wifiAccessPointSelect = document.getElementById("wifiAccessPointSelect");
    for( i=wifiAccessPointSelect.length - 1; i >= 0; i-- ) { // must do in reverse
      wifiAccessPointSelect.remove(i);
    }
    
    // Add updated wifi access point selections
    for( i=0; i < wifiAccessPoints.length; i++ ) {
      wifiAccessPoint = wifiAccessPoints[i];
      var option = document.createElement("option");
      option.text = wifiAccessPoint.ssid;
      option.value = wifiAccessPoint.service;
      wifiAccessPointSelect.add(option);
    }
  }

  function getSystemInfo() {
    console.log("Getting system info")
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: "/api/system/info/",
        type: "GET",
        data: {
          "csrfmiddlewaretoken": "{{ csrf_token }}"
        },
        dataType: 'json',
        success: function(data) {
          console.log("Got system info")
          var systemInfo = {
            "isBeaglebone": data["is_beaglebone"],
            "isWifiBeaglebone": data["is_wifi_beaglebone"],
            "beagleboneSerialNumber": data["beaglebone_serial_number"],
            "remoteDeviceUiUrl": data["remote_device_ui_url"]
          };
          resolve(systemInfo);
        },
        error: function(data) {
          response_dict = JSON.parse(data.responseText);
          message = response_dict["message"];
          console.log(message);
          var systemInfo = {};
          reject(systemInfo);
        }
      });
    });
  }

  function getNetworkInfo() {
    console.log("Getting network info")
    return new Promise(function (resolve, reject) {
      $.ajax({
        url: "/api/network/info/",
        type: "GET",
        data: {
          "csrfmiddlewaretoken": "{{ csrf_token }}"
        },
        dataType: 'json',
        success: function(data) {
          console.log("Got network info")
          var networkInfo = {
            "isConnected": data["is_connected"],
            "ipAddress": data["ip_address"],
            "wifiAccessPoints": data["wifi_access_points"]
          }
          resolve(networkInfo);
        },
        error: function(data) {
          console.log("Unable to get network info")
          response_dict = JSON.parse(data.responseText)
          message = response_dict["message"]
          console.log(message);
          var networkInfo = {};
          reject(networkInfo);
        }
      });
    });
  }



  // function joinWifi() {
  //   console.log("Joining wifi")
    
  //   // Update status
  //   document.getElementById("status").innerHTML = 'Joining wifi, this will take a few minutes...'

  //   // Get wifi name
  //   var wifiName = document.getElementById("wifiAccessPoints");
  //   if( wifiName == null ) {
  //     console.log("Error: could not get wifiAccessPoints element")
  //     return
  //   }

  //   // Get wifi password
  //   var wifiPassword = document.getElementById("wifi-password");
  //   if( wifiPassword == null ) {
  //     console.log("Error: could not get wifi-password element")
  //     return
  //   }

  //   // Send join wifi request
  //   console.log("Sending join wifi request")
  //   $.ajax({
  //     url: "/api/connect/joinwifi/",
  //     type: "POST",
  //     data: {
  //       "csrfmiddlewaretoken": "{{ csrf_token }}",
  //       "wifi": wifiName.value,
  //       "password": wifiPassword.value
  //     },
  //     dataType: 'json',
  //     success: function(data) {
  //       console.log(data['message'])
  //       console.log(data)

  //       // TODO: updateView(data['status'], data['upgrade_available'], data['current_version'], data['upgrade_version']);
  //     },
  //     error: function(data) {
  //       response_dict = JSON.parse(data.responseText)
  //       message = response_dict["message"]
  //       console.log(message);
  //       console.log(response_dict)

  //       // TODO: updateView(response_dict['status'], response_dict['upgrade_available'], response_dict['current_version'], response_dict['upgrade_version']);
  //     }
  //   });
  // }



  function makePasswordVisible() {
    var pass = document.getElementById("wifi-password");
    if (pass.type === "password") {
        pass.type = "text";
    } else {
        pass.type = "password";
    }
  }

</script>
{% endblock %}


{% block content %}

{% csrf_token %}

<html>

<input type="hidden" id="wifi-access-points" name="variable" value="{{ wifi_access_points }}">

<body>

<div class="connect">
  
  <h2>Connect</h2>
  <div class="card" id="connect-card">
    
    <h3>Networking</h3></br>

    <p>
      <b>Status:</b> <span id="status"></span>
    </p>
    
    <div class="collapse" id="configure-wifi-collapse">
      <select id="wifi-access-points" class="selectpicker" style="width:200px">
        {% for wifi_access_point in wifi_access_points %}
        <option value={{wifi_access_point.service}}>{{wifi_assess_point.ssid}}</option>
        {% endfor %}
      </select>

      <p>
        <input type="password" id="wifi-password" 
         onkeydown="if (event.keyCode==13) document.getElementById('join-wifi-button').click()"
         placeholder='Wifi Password' style="width:200px">
        <input type="checkbox" onclick="makePasswordVisible()"> Show Password
      </p>

      <a class="badge badge-secondary" data-toggle="collapse" id="join-wifi-button"
        style="width:200px" href="" role="button" onclick="joinWifi();">
        Join Wifi</a>
      </br>

      <p>
        If you have trouble connecting to your wireless network, please try the: <a href="/connect/advanced">Advanced wireless network configuration</a> 
      </p>
    </div>

    
    <div class="collapse" id="connection-info-collapse">
      <ul>
        <li><b>Device IP Address:</b> <span id="ip-address"></span>
        <li><b>Web UI:</b> <a id="cloud-ui-url" href="https://openag-v1.appspot.com/login" target="_blank">OpenAg Web UI</a>
        <li><b>Remotely Accessible Device UI:</b> <a id="remote-device-ui-url" href="" target="_blank"></a>
      </ul>
    </div>

  </div>
  </div>

</div>
</body>
</html>
{% endblock %}
