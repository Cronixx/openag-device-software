{% extends 'base.html' %}

{% block javascript %}
<script>
  
  window.onload = function() {

    var status = "{{ status }}"
    var internetIsConnected = ("{{ internet_is_connected }}" == "True")
    var wifiAccessPoints = []
    var ipAddress = "{{ ip_address }}"

    updateView(status, internetIsConnected, ipAddress, wifiAccessPoints)

  }

  function updateView(status, internetIsConnected, ipAddress) {
    console.log("Updating view");

    // Display connection info
    document.getElementById("status").innerHTML = status;
    document.getElementById("ip-address").innerHTML = ipAddress;
    document.getElementById("remote-device-ui-url").innerHTML = remoteDeviceUI;
    document.getElementById("remote-device-ui-url").href = remoteDeviceUI;
    document.getElementById("web-ui-url").innerHTML = 'Please click here to create your user account, and connect your PFC to the OpenAg Cloud';
    // document.getElementById("verification_code").href = "https://openag-v1.appspot.com/login?vcode=" + data['verification_code'];


    // Remove stale wifi access point selections
    console.log("Removing stale wifi access point selections")
    var wifiAccessPointSelect = document.getElementById("wifiAccessPointSelect");
    for( i=wifiAccessPointSelect.length - 1; i >= 0; i-- ) { // must do in reverse
      wifiAccessPointSelect.remove(i);
    }
    
    // Add updated wifi access point selections
    console.log("Adding updated wifi access point selections")
    for( i=0; i < wifiAccessPoints.length; i++ ) {
      wifiAccessPoint = wifiAccessPoints[i];
      var option = document.createElement("option");
      option.text = wifiAccessPoint.ssid;
      option.value = wifiAccessPoint.service;
      wifiAccessPointSelect.add(option);
    }

  }

  function joinWifi() {
    console.log("Joining wifi")
    
    // Update status
    document.getElementById("status").innerHTML = 'Connecting, this will take a few minutes...'

    // Get wifi name
    var wifiName = document.getElementById("wifiAccessPoints");
    if( wifiName == null ) {
      console.log("Error: could not get wifiAccessPoints element")
      return
    }

    // Get wifi password
    var wifiPassword = document.getElementById("wifi-password");
    if( wifiPassword == null ) {
      console.log("Error: could not get wifi-password element")
      return
    }

    // Send join wifi request
    console.log("Sending join wifi request")
    $.ajax({
      url: "/api/connect/joinwifi/",
      type: "POST",
      data: {
        "csrfmiddlewaretoken": "{{ csrf_token }}",
        "wifi": wifiName.value,
        "password": wifiPassword.value
      },
      dataType: 'json',
      success: function(data) {
        console.log(data['message'])
        console.log(data)

        // TODO: updateView(data['status'], data['upgrade_available'], data['current_version'], data['upgrade_version']);
      },
      error: function(data) {
        response_dict = JSON.parse(data.responseText)
        message = response_dict["message"]
        console.log(message);
        console.log(response_dict)

        // TODO: updateView(response_dict['status'], response_dict['upgrade_available'], response_dict['current_version'], response_dict['upgrade_version']);
      }
    });
  }


  // function getStatusPromise() {
  //   return new Promise(function (resolve, reject) {
  //     $.ajax({
  //       url: "/api/connect/status/",
  //       type: "GET",
  //       data: {"csrfmiddlewaretoken": "{{ csrf_token }}"},
  //       dataType: "json",
  //       success: function(data) {
  //         document.getElementById("status").innerHTML = data['status'];
  //         document.getElementById("ip_address").innerHTML = data['ip_address'];
  //         document.getElementById("remote-device-ui-url").innerHTML = data['remote-device-ui-url'];

  //         if( data['verification_code'] != "None" ) {
  //           document.getElementById("verification_code").innerHTML = 'Please click here to create your user account, and connect your PFC to the OpenAg Cloud';
  //           document.getElementById("verification_code").href = "https://openag-v1.appspot.com/login?vcode=" + data['verification_code'];
  //         }

  //         // update the page to match the status
  //         if(data['is_bbb']) {
  //           $('#is_bbb').collapse('show');
  //         }
  //         if(data['is_wifi_bbb'] && ! data['internet_is_connected']) {
  //           $('#show_wifi').collapse('show');
  //           $('#show_dev_UI').collapse('hide');
  //         } else {
  //           $('#show_wifi').collapse('hide');
  //           $('#show_dev_UI').collapse('show');
  //         }

  //         // clean out the existing wifis
  //         var wifiName = document.getElementById("wifiAccessPoints");
  //         for( i=wifiName.length - 1; i >= 0; i-- ) { // must do in reverse
  //           wifiName.remove(i);
  //         }
  //         // add new wifis we just received
  //         wifiAccessPoints = data['wifis'];
  //         for( i=0; i < wifiAccessPoints.length; i++ ) {
  //           wifi = wifiAccessPoints[i];
  //           var option = document.createElement("option");
  //           option.text = wifi.ssid;
  //           option.value = wifi.service;
  //           wifiName.add(option);
  //         }

  //         var statusDict = data;
  //         resolve(statusDict);
  //       },
  //       error: function(data) {
  //         console.log("Promise Error: getStatus failed");
  //         document.getElementById("status").innerHTML = 'Could not get status.';
  //         reject(data);
  //       }
  //     });
  //   })
  // }

  function makePasswordVisible() {
    var pass = document.getElementById("wifi-password");
    if (pass.type === "password") {
        pass.type = "text";
    } else {
        pass.type = "password";
    }
  }

</script>
{% endblock %}



{% block content %}

{% csrf_token %}

<html>

<input type="hidden" id="wifi-access-points" name="variable" value="{{ wifi_access_points }}">

<body>

<div class="connect">
  
  <h2>Connect</h2>
  <div class="card" id="connect-card">
    
    <h3>Networking</h3></br>
    <div class="collapse" id="networking-collapse">
      <select id="wifi-access-points" class="selectpicker" style="width:200px">
        {% for wifi_access_point in wifi_access_points %}
        <option value={{wifi_access_point.service}}>{{wifi_assess_point.ssid}}</option>
        {% endfor %}
      </select>
      <p>
        <input type="password" id="wifi-password" 
         onkeydown="if (event.keyCode==13) document.getElementById('join-wifi-button').click()"
         placeholder='Wifi Password' style="width:200px">
        <input type="checkbox" onclick="makePasswordVisible()"> Show Password
      </p>
      <a class="badge badge-secondary" data-toggle="collapse" id="join-wifi-button"
        style="width:200px" href="" role="button" onclick="joinWifi();">
        Join Wifi</a>
      </br>

      <p>
        If you have trouble connecting to your wireless network, please try the: <a href="/connect/advanced">Advanced wireless network configuration</a> 
      </p>
    </div>

    <p>
      <b>Status:</b> <span id="status"></span>
    </p>

    <div class="collapse" id="device-ui-collapse">
      <ul>
        <li><b>Device IP Address:</b> <span id="ip-address"></span>
        <li><b>Web UI:</b> <a id="web-ui-url" href="https://openag-v1.appspot.com/login" target="_blank">OpenAg Web UI</a>
        <li><b>Remotely Accessible Device UI:</b> <a id="remote-device-ui-url" href="" target="_blank"></a>
      </ul>
    </div>
  </div>

</div>
</body>
</html>
{% endblock %}
